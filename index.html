<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ZXing QR Test (Canvas)</title>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    body { margin:0; background:#000; color:#fff; font-family:-apple-system,system-ui; }
    #hud { position:fixed; top:10px; left:10px; background:rgba(0,0,0,.6); padding:8px; }
    video { width:100vw; height:100vh; object-fit:cover; }
    canvas { display:none; }
  </style>
</head>
<body>

<div id="hud">starting…</div>
<video id="video" playsinline webkit-playsinline muted></video>
<canvas id="c"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d", { willReadFrequently:true });
const hud = document.getElementById("hud");
const reader = new ZXing.BrowserQRCodeReader();

async function start() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode:{ ideal:"environment" } },
    audio:false
  });
  video.srcObject = stream;
  await video.play();
  hud.textContent = "CAMERA OK – scanning…";
  scan();
}

function scan() {
  if (video.readyState < 2) {
    requestAnimationFrame(scan);
    return;
  }

  // Downscale → ZXing mag das
  const w = 640;
  const h = Math.round(video.videoHeight / video.videoWidth * w);
  canvas.width = w;
  canvas.height = h;
  ctx.drawImage(video, 0, 0, w, h);

  try {
    const result = reader.decodeFromCanvas(canvas);
    hud.textContent = "QR FOUND:\n" + result.getText();
  } catch (e) {
    hud.textContent = "scanning…";
  }

  requestAnimationFrame(scan);
}

start();
</script>
</body>
</html>
