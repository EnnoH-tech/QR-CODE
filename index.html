<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR – Pattern Marker (Stable HUD)</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    html, body { margin:0; padding:0; background:#000; overflow:hidden; font-family:-apple-system,system-ui,sans-serif; }
    #start {
      position: fixed; inset: 0;
      display: grid; place-items: center;
      background: #000; color:#fff; z-index: 10;
    }
    #btn {
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.12);
    }
    #hud{
      position: fixed; top:10px; left:10px;
      padding: 8px 10px;
      background: rgba(0,0,0,.65);
      color:#fff; font-size: 13px;
      border-radius: 6px;
      white-space: pre-line;
      z-index: 20;
      user-select:none; -webkit-user-select:none;
    }
  </style>
</head>

<body>
  <div id="start"><div id="btn">Start AR</div></div>
  <div id="hud">WAITING FOR TAP</div>

  <script>
    const HUD = document.getElementById("hud");
    const START = document.getElementById("start");

    const BASE = "/QR-CODE"; // <- Repo-Pfad auf GitHub Pages
    const PATT_URL = `${BASE}/patternbw.patt?v=7`; // v hochzählen bei Änderungen (iOS Cache!)
    const MODEL_URL = `${BASE}/enno6_test.glb?v=7`;

    let state = {
      boot: "waiting",
      scene: "…",
      arjs: "…",
      video: "…",
      patt: "…",
      marker: "waiting",
      model: "loading…"
    };

    function renderHUD() {
      HUD.textContent = [
        `BOOT: ${state.boot}`,
        `SCENE: ${state.scene}`,
        `ARJS: ${state.arjs}`,
        `VIDEO: ${state.video}`,
        `PATT: ${state.patt}`,
        `MARKER: ${state.marker}`,
        `MODEL: ${state.model}`,
      ].join("\n");
    }

    document.getElementById("btn").addEventListener("click", () => {
      START.remove();
      state.boot = "init…";
      renderHUD();
      initAR();
    });

    async function checkPattFetch() {
      try {
        const r = await fetch(PATT_URL, { cache: "no-store" });
        if (!r.ok) {
          state.patt = `HTTP ${r.status}`;
          renderHUD();
          return;
        }
        const txt = await r.text();
        state.patt = `OK (${txt.length})`;
        renderHUD();
      } catch (e) {
        state.patt = "FETCH ERROR";
        renderHUD();
      }
    }

    function initAR() {
      // Vorab: prüfen ob .patt überhaupt erreichbar ist
      checkPattFetch();

      const scene = document.createElement("a-scene");
      scene.setAttribute("embedded", "");
      scene.setAttribute("vr-mode-ui", "enabled:false");
      scene.setAttribute("renderer", "colorManagement:true");
      scene.setAttribute(
        "arjs",
        "sourceType: webcam; videoTexture:true; trackingMethod:best; debugUIEnabled:false;"
      );

      scene.innerHTML = `
        <a-assets>
          <a-asset-item id="model" src="${MODEL_URL}"></a-asset-item>
        </a-assets>

        <a-marker id="marker" type="pattern" url="${PATT_URL}">
          <a-entity light="type: ambient; intensity: 1.5"></a-entity>
          <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>

          <!-- Debug-Würfel -->
          <a-box position="0 0.25 0" depth="0.25" height="0.25" width="0.25"></a-box>

          <!-- Modell -->
          <a-entity id="modelEnt" gltf-model="#model" position="0 0 0" rotation="0 0 0" scale="1 1 1"></a-entity>
        </a-marker>

        <a-entity camera look-controls="enabled:false" wasd-controls="enabled:false"></a-entity>
      `;

      document.body.appendChild(scene);

      scene.addEventListener("loaded", () => {
        state.boot = "ok";
        state.scene = "loaded";
        state.arjs = (scene.systems && scene.systems["arjs"]) ? "present" : "missing";
        renderHUD();

        // iOS: Video prüfen + play anstoßen
        setTimeout(() => {
          const v = document.querySelector("video");
          state.video = v ? "present" : "missing";
          renderHUD();

          if (v) {
            v.setAttribute("playsinline", "");
            v.setAttribute("webkit-playsinline", "");
            v.muted = true;
            v.play().catch(()=>{});
          }
        }, 500);

        // Modellstatus
        const modelEnt = document.getElementById("modelEnt");
        if (modelEnt) {
          modelEnt.addEventListener("model-loaded", () => { state.model = "LOADED"; renderHUD(); });
          modelEnt.addEventListener("model-error",  () => { state.model = "ERROR";  renderHUD(); });
        }

        // Markerstatus: NICHT Events, sondern visible polling (zuverlässig)
        const marker = document.getElementById("marker");
        let last = null;

        setInterval(() => {
          const v = document.querySelector("video");
          state.video = v ? "present" : "missing";

          if (marker && marker.object3D) {
            const vis = marker.object3D.visible;
            if (vis !== last) {
              last = vis;
              state.marker = vis ? "FOUND" : "LOST";
            }
          } else {
            state.marker = "missing";
          }

          renderHUD();
        }, 250);
      });
    }
  </script>
</body>
</html>
