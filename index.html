<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR – Pattern Marker Debug (Hard)</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

    <style>
      #hud {
        position: fixed;
        top: 10px;
        left: 10px;
        padding: 8px 10px;
        background: rgba(0,0,0,0.65);
        color: #fff;
        font: 14px/1.25 -apple-system, system-ui, sans-serif;
        border-radius: 6px;
        z-index: 9999;
        white-space: pre-line;
      }
    </style>
  </head>

  <body style="margin:0; overflow:hidden; background:black;">
    <div id="hud">BOOT: …</div>

    <a-scene
      id="scene"
      embedded
      vr-mode-ui="enabled:false"
      renderer="colorManagement:true"
      arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: true;"
    >
      <a-assets>
        <a-asset-item id="model" src="./enno6_test.glb"></a-asset-item>
      </a-assets>

      <a-marker id="m" type="pattern" url="./patternbw.patt">
        <a-entity light="type: ambient; intensity: 1.6"></a-entity>
        <a-entity light="type: directional; intensity: 1" position="1 2 1"></a-entity>

        <!-- Muss sichtbar sein sobald Marker FOUND -->
        <a-box position="0 0.25 0" depth="0.3" height="0.3" width="0.3"></a-box>

        <a-entity
          id="modelEnt"
          gltf-model="#model"
          position="0 0 0"
          rotation="0 0 0"
          scale="1 1 1"
        ></a-entity>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>

    <script>
      const hud = document.getElementById("hud");
      const scene = document.getElementById("scene");
      const marker = document.getElementById("m");
      const modelEnt = document.getElementById("modelEnt");

      const set = (lines) => (hud.textContent = lines.join("\n"));

      set([
        "BOOT: starting…",
        "SCENE: …",
        "ARJS: …",
        "MARKER: …",
        "MODEL: …",
      ]);

      // Szene geladen?
      scene.addEventListener("loaded", () => {
        set([
          "BOOT: ok",
          "SCENE: loaded",
          "ARJS: " + (scene.systems && scene.systems["arjs"] ? "present" : "missing"),
          "MARKER: waiting",
          "MODEL: waiting",
        ]);
      });

      // Marker Events
      marker.addEventListener("markerFound", () => {
        set([
          "BOOT: ok",
          "SCENE: loaded",
          "ARJS: " + (scene.systems && scene.systems["arjs"] ? "present" : "missing"),
          "MARKER: FOUND",
          "MODEL: (see status)",
        ]);
      });

      marker.addEventListener("markerLost", () => {
        set([
          "BOOT: ok",
          "SCENE: loaded",
          "ARJS: " + (scene.systems && scene.systems["arjs"] ? "present" : "missing"),
          "MARKER: LOST",
          "MODEL: (loaded?)",
        ]);
      });

      // Modell Events
      modelEnt.addEventListener("model-loaded", () => {
        const lines = hud.textContent.split("\n");
        lines[4] = "MODEL: LOADED";
        hud.textContent = lines.join("\n");
      });

      modelEnt.addEventListener("model-error", () => {
        const lines = hud.textContent.split("\n");
        lines[4] = "MODEL: ERROR";
        hud.textContent = lines.join("\n");
      });

      // Falls gar nichts feuert, nach 3s einen Status-Snapshot
      setTimeout(() => {
        const arjsPresent = !!(scene.systems && scene.systems["arjs"]);
        const hasVideo = !!document.querySelector("video");

        set([
          "BOOT: ok (timeout snapshot)",
          "SCENE: " + (scene.hasLoaded ? "loaded" : "not loaded"),
          "ARJS: " + (arjsPresent ? "present" : "missing"),
          "VIDEO: " + (hasVideo ? "present" : "missing"),
          "MARKER: no events yet",
        ]);
      }, 3000);
    </script>
  </body>
</html>
